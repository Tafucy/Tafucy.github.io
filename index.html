<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusGoal Mini App</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <!-- –•–µ–¥–µ—Ä —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π -->
        <header class="app-header">
            <div class="header-content">
                <h1 class="app-title">üéØ FocusGoal</h1>
                <div class="user-profile">
                    <div class="xp-display">
                        <div class="xp-value">{{ user.xp }} XP</div>
                        <div class="level-badge">–£—Ä–æ–≤–µ–Ω—å {{ user.level }}</div>
                    </div>
                    <div class="level-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ level_progress }}%"></div>
                        </div>
                        <div class="progress-text">{{ level_progress|round }}% –¥–æ —Å–ª–µ–¥. —É—Ä–æ–≤–Ω—è</div>
                    </div>
                </div>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <div class="stat-value">{{ stats.goals.total|default(0) }}</div>
                    <div class="stat-label">–¶–µ–ª–µ–π</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ stats.habits.total|default(0) }}</div>
                    <div class="stat-label">–ü—Ä–∏–≤—ã—á–µ–∫</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">{{ stats.focus.total_sessions|default(0) }}</div>
                    <div class="stat-label">–§–æ–∫—É—Å-—Å–µ—Å—Å–∏–π</div>
                </div>
            </div>
        </header>

        <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <section class="quick-actions-section">
            <h2 class="section-title">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
            <div class="actions-grid">
                <button class="action-btn primary" onclick="createGoal()">
                    <span class="btn-icon">üéØ</span>
                    <span class="btn-text">–ù–æ–≤–∞—è —Ü–µ–ª—å</span>
                </button>
                <button class="action-btn secondary" onclick="createHabit()">
                    <span class="btn-icon">üîÑ</span>
                    <span class="btn-text">–ù–æ–≤–∞—è –ø—Ä–∏–≤—ã—á–∫–∞</span>
                </button>
                <button class="action-btn accent" onclick="startFocusSession()">
                    <span class="btn-icon">üéÆ</span>
                    <span class="btn-text">–§–æ–∫—É—Å</span>
                </button>
                <button class="action-btn" onclick="showStats()">
                    <span class="btn-icon">üìä</span>
                    <span class="btn-text">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
                </button>
            </div>
        </section>

        <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Ü–µ–ª–∏ -->
        <section class="goals-section">
            <div class="section-header">
                <h2 class="section-title">üéØ –ú–æ–∏ —Ü–µ–ª–∏</h2>
                <span class="section-count">{{ goals|length }}</span>
            </div>
            
            {% if goals %}
            <div class="cards-grid">
                {% for goal in goals %}
                <div class="goal-card {% if goal.status == 'completed' %}completed{% endif %} priority-{{ goal.priority }}">
                    <div class="card-header">
                        <h3 class="goal-title">{{ goal.title }}</h3>
                        <span class="priority-badge">{{ goal.priority }}</span>
                    </div>
                    
                    {% if goal.description %}
                    <p class="goal-description">{{ goal.description }}</p>
                    {% endif %}
                    
                    <div class="card-footer">
                        <div class="goal-meta">
                            {% if goal.deadline %}
                            <span class="deadline">
                                üìÖ {{ goal.deadline[:10] }}
                            </span>
                            {% endif %}
                            <span class="status">
                                {% if goal.status == 'completed' %}‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ{% else %}‚è≥ –ê–∫—Ç–∏–≤–Ω–∞{% endif %}
                            </span>
                        </div>
                        
                        {% if goal.status != 'completed' %}
                        <button class="btn-complete" onclick="completeGoal({{ goal.id }})">
                            ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üéØ</div>
                <h3>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π</h3>
                <p>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é —Ü–µ–ª—å!</p>
                <button class="btn-primary" onclick="createGoal()">–°–æ–∑–¥–∞—Ç—å —Ü–µ–ª—å</button>
            </div>
            {% endif %}
        </section>

        <!-- –ü—Ä–∏–≤—ã—á–∫–∏ -->
        <section class="habits-section">
            <div class="section-header">
                <h2 class="section-title">üîÑ –ú–æ–∏ –ø—Ä–∏–≤—ã—á–∫–∏</h2>
                <span class="section-count">{{ habits|length }}</span>
            </div>
            
            {% if habits %}
            <div class="habits-list">
                {% for habit in habits %}
                <div class="habit-card">
                    <div class="habit-info">
                        <h3 class="habit-title">{{ habit.title }}</h3>
                        <div class="habit-meta">
                            <span class="frequency">üìÖ {{ habit.frequency }}</span>
                            <span class="streak">üî• {{ habit.streak }} –¥–Ω–µ–π</span>
                        </div>
                    </div>
                    <button class="btn-track" onclick="trackHabit({{ habit.id }})">
                        ‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å
                    </button>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üîÑ</div>
                <h3>–ù–µ—Ç –ø—Ä–∏–≤—ã—á–µ–∫</h3>
                <p>–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É!</p>
                <button class="btn-secondary" onclick="createHabit()">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É</button>
            </div>
            {% endif %}
        </section>

        <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
        <section class="achievements-section">
            <div class="section-header">
                <h2 class="section-title">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
                <span class="section-count">{{ achievements|length }}</span>
            </div>
            
            {% if achievements %}
            <div class="achievements-grid">
                {% for achievement in achievements %}
                <div class="achievement-card">
                    <div class="achievement-icon">{{ achievement.icon }}</div>
                    <div class="achievement-info">
                        <h4>{{ achievement.name }}</h4>
                        <p>{{ achievement.description }}</p>
                        <div class="achievement-date">
                            üìÖ {{ achievement.unlocked_at[:10] }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üèÜ</div>
                <h3>–ù–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</h3>
                <p>–í—ã–ø–æ–ª–Ω—è–π—Ç–µ —Ü–µ–ª–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è!</p>
            </div>
            {% endif %}
        </section>

        <!-- –§—É—Ç–µ—Ä -->
        <footer class="app-footer">
            <div class="footer-actions">
                <button class="footer-btn" onclick="refreshData()">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                </button>
                <button class="footer-btn" onclick="openStats()">
                    üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                </button>
                <button class="footer-btn" onclick="closeApp()">
                    ‚úï –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </footer>
    </div>

    <!-- –°–∫—Ä–∏–ø—Ç—ã -->
    <script src="/static/main.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        let tg = null;
        if (typeof Telegram !== 'undefined') {
            tg = window.Telegram.WebApp;
            tg.expand();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            tg.MainButton.setText("–ó–∞–∫—Ä—ã—Ç—å");
            tg.MainButton.onClick(() => tg.close());
            tg.MainButton.show();
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const telegramUser = tg.initDataUnsafe.user;
                console.log('Telegram user:', telegramUser);
            }
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        const userId = {{ user.id }};
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º
        function createGoal() {
            window.location.href = `/new_goal?user_id=${userId}`;
        }
        
        function createHabit() {
            const title = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏:');
            if (!title) return;
            
            fetch('/api/habits', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    user_id: userId,
                    title: title,
                    frequency: 'daily'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–∏–≤—ã—á–∫–∏');
            });
        }
        
        function completeGoal(goalId) {
            if (!confirm('–û—Ç–º–µ—Ç–∏—Ç—å —Ü–µ–ª—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é?')) return;
            
            fetch(`/api/goals/${goalId}/complete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    user_id: userId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ü–µ–ª–∏');
            });
        }
        
        function trackHabit(habitId) {
            fetch(`/api/habits/${habitId}/track`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    user_id: userId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –ø—Ä–∏–≤—ã—á–∫–∏');
            });
        }
        
        function startFocusSession() {
            const duration = prompt('–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ñ–æ–∫—É—Å-—Å–µ—Å—Å–∏–∏ (–º–∏–Ω—É—Ç—ã):', '25');
            if (!duration || isNaN(duration)) return;
            
            fetch('/api/focus/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    user_id: userId,
                    duration: duration
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    
                    // –¢–∞–π–º–µ—Ä –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
                    setTimeout(() => {
                        alert(`‚úÖ –§–æ–∫—É—Å-—Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! +${duration * 2} XP –Ω–∞—á–∏—Å–ª–µ–Ω–æ`);
                    }, 3000); // 3 —Å–µ–∫—É–Ω–¥—ã –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω—ã—Ö –º–∏–Ω—É—Ç
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ñ–æ–∫—É—Å-—Å–µ—Å—Å–∏–∏');
            });
        }
        
        function showStats() {
            window.location.href = `/stats?user_id=${userId}`;
        }
        
        function openStats() {
            showStats();
        }
        
        function refreshData() {
            window.location.reload();
        }
        
        function closeApp() {
            if (tg) {
                tg.close();
            } else {
                alert('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–∫—Ä—ã—Ç–æ —Ç–æ–ª—å–∫–æ –∏–∑ Telegram');
            }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.addEventListener('load', function() {
            console.log('FocusGoal Mini App –∑–∞–≥—Ä—É–∂–µ–Ω');
            console.log('User ID:', userId);
        });
    </script>
</body>
</html>
